<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PayControl ‚Äî –¢—Ä–µ–∫–µ—Ä –ª–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="logo-wrap">
        <div class="logo-mark">‚ÇΩ</div>
        <div class="logo-text">
          <span class="logo-title">PayControl</span>
          <span class="logo-subtitle">–¢—Ä–µ–∫–µ—Ä –ª–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-ghost" id="telegramNotify" type="button">üì¨ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</button>
        <button class="btn btn-ghost" id="themeToggle" type="button">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
      </div>
    </header>

    <main class="app-main">
      <section class="dashboard">
        <div class="card kpi-card">
          <div class="card-header">
            <span class="card-title">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π / –º–µ—Å—è—Ü</span>
          </div>
          <div class="card-value" id="totalMonthly">0 ‚ÇΩ</div>
        </div>

        <div class="card kpi-card">
          <div class="card-header">
            <span class="card-title">–ë–ª–∏–∂–∞–π—à–∏–π –ø–ª–∞—Ç—ë–∂</span>
          </div>
          <div class="card-value" id="nextPayment">‚Äî</div>
          <div class="card-meta" id="nextPaymentMeta">–î–∞—Ç–∞ –∏ —Å—É–º–º–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>
        </div>

        <div class="card kpi-card">
          <div class="card-header">
            <span class="card-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</span>
          </div>
          <div class="tags">
            <span class="tag">–ü–æ–¥–ø–∏—Å–∫–∏: <span id="countSubscription">0</span></span>
            <span class="tag">–ñ–ö–•: <span id="countUtilities">0</span></span>
            <span class="tag">–ö—Ä–µ–¥–∏—Ç—ã: <span id="countCredit">0</span></span>
            <span class="tag">–î—Ä—É–≥–æ–µ: <span id="countOther">0</span></span>
          </div>
        </div>
      </section>

      <section class="layout-two-column">
        <section class="card form-card">
          <div class="card-header">
            <span class="card-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂</span>
          </div>
          <form id="paymentForm" class="form" method="post" onsubmit="return false;">
            <div class="form-row">
              <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input id="name" name="name" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, Spotify, –∞—Ä–µ–Ω–¥–∞" required />
            </div>

            <div class="form-row">
              <label for="amount">–°—É–º–º–∞, ‚ÇΩ</label>
              <input id="amount" name="amount" type="number" min="0" step="0.01" placeholder="0.00" required />
            </div>

            <div class="form-row">
              <label for="date">–î–∞—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è</label>
              <input id="date" name="date" type="date" required />
            </div>

            <div class="form-row">
              <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select id="category" name="category" required>
                <option value="subscription">–ü–æ–¥–ø–∏—Å–∫–∞</option>
                <option value="utilities">–ñ–ö–•</option>
                <option value="credit">–ö—Ä–µ–¥–∏—Ç</option>
                <option value="other">–î—Ä—É–≥–æ–µ</option>
              </select>
            </div>

            <div class="form-actions">
              <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</button>
              <button class="btn btn-ghost" type="reset">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
          </form>
        </section>

        <section class="card table-card">
          <div class="card-header table-header">
            <span class="card-title">–°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π</span>
            <div class="table-actions">
              <input
                type="search"
                id="searchInput"
                class="search-input"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..."
              />
            </div>
          </div>

          <div class="table-wrapper">
            <table class="payments-table">
              <thead>
                <tr>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–°—É–º–º–∞</th>
                  <th>–î–∞—Ç–∞</th>
                  <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="paymentsBody">
                <!-- –ó–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
              </tbody>
            </table>
            <div class="table-empty" id="tableEmptyState">
              –ü–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ä–º—ã —Å–ª–µ–≤–∞.
            </div>
          </div>
        </section>
      </section>
    </main>

    <footer class="app-footer">
      <span>PayControl ¬© <span id="currentYear"></span></span>
      <span class="footer-hint">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ</span>
    </footer>
  </div>

  <script>
    (function () {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
      const supabaseUrl = 'https://dlhmcrmwndlwzaaogyoy.supabase.co';
      const supabaseKey = 'sb_publishable_h6w08Q0zo8C1ZRRU0xX5lQ_zN7wJnOF';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      const form = document.getElementById('paymentForm');
      const paymentsBody = document.getElementById('paymentsBody');
      const tableEmptyState = document.getElementById('tableEmptyState');
      const totalMonthlyEl = document.getElementById('totalMonthly');
      const nextPaymentEl = document.getElementById('nextPayment');
      const nextPaymentMetaEl = document.getElementById('nextPaymentMeta');
      const searchInput = document.getElementById('searchInput');

      const countSubscriptionEl = document.getElementById('countSubscription');
      const countUtilitiesEl = document.getElementById('countUtilities');
      const countCreditEl = document.getElementById('countCredit');
      const countOtherEl = document.getElementById('countOther');

      const currentYearEl = document.getElementById('currentYear');
      const themeToggleBtn = document.getElementById('themeToggle');
      const telegramNotifyBtn = document.getElementById('telegramNotify');

      // Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      const telegramBotToken = '8035741485:AAFGXxbJSqLOnhdeFKuEgpZtvnIejvaAJqU';
      const telegramChatId = '250941181';

      let payments = [];
      let currentEditingId = null;

      const submitBtn = form.querySelector('button[type="submit"]');

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
      form.addEventListener('submit', async (event) => {
        event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

        const formData = new FormData(form);
        const name = String(formData.get('name') || '').trim();
        const amount = Number(formData.get('amount') || 0);
        const date = String(formData.get('date') || '');
        const category = String(formData.get('category') || 'other');

        if (!name || !date || !amount || amount <= 0) {
          alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.');
          return;
        }

        if (currentEditingId) {
          const updatedPayment = await updatePayment(currentEditingId, {
            name,
            amount,
            date,
            category
          });

          if (updatedPayment) {
            currentEditingId = null;
            submitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂';
            await loadPayments();
          }
        } else {
          const newPayment = await savePayment({
            name,
            amount,
            date,
            category
          });

          if (newPayment) {
            await loadPayments();
          }
        }

        form.reset();
      });

      form.addEventListener('reset', () => {
        currentEditingId = null;
        submitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂';
      });

      searchInput.addEventListener('input', () => {
        renderTable(searchInput.value);
      });

      // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
      async function sendTelegramMessage(message) {
        try {
          const response = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              chat_id: telegramChatId,
              text: message,
              parse_mode: 'HTML'
            })
          });

          const data = await response.json();
          if (!data.ok) {
            throw new Error(data.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
          }

          return true;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
          return false;
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
      async function sendPaymentNotifications() {
        const now = new Date();
        now.setHours(0, 0, 0, 0);

        const urgentPayments = [];
        const upcomingPayments = [];

        payments.forEach(payment => {
          const paymentDate = new Date(payment.date);
          paymentDate.setHours(0, 0, 0, 0);
          
          const daysDiff = Math.ceil((paymentDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

          if (daysDiff >= 0 && daysDiff <= 3) {
            urgentPayments.push(payment);
          } else if (daysDiff >= 4 && daysDiff <= 7) {
            upcomingPayments.push(payment);
          }
        });

        let message = '<b>üìä –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö</b>\n\n';

        if (urgentPayments.length > 0) {
          message += '<b>‚ö†Ô∏è –°—Ä–æ—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:</b>\n';
          urgentPayments.forEach(payment => {
            message += `‚Ä¢ ${payment.name} ‚Äî ${formatCurrency(payment.amount)}, —Å–ø–∏—Å–∞–Ω–∏–µ ${formatDate(payment.date)}\n`;
          });
          message += '\n';
        }

        if (upcomingPayments.length > 0) {
          message += '<b>üìÖ –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏:</b>\n';
          upcomingPayments.forEach(payment => {
            message += `‚Ä¢ ${payment.name} ‚Äî ${formatCurrency(payment.amount)}, —Å–ø–∏—Å–∞–Ω–∏–µ ${formatDate(payment.date)}\n`;
          });
          message += '\n';
        }

        if (urgentPayments.length === 0 && upcomingPayments.length === 0) {
          message += '‚úÖ –ë–ª–∏–∂–∞–π—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç\n\n';
        }

        const totalMonthly = payments.reduce((sum, p) => sum + Number(p.amount || 0), 0);
        message += `<b>üí∞ –û–±—â–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≤ –º–µ—Å—è—Ü: ${formatCurrency(totalMonthly)}</b>`;

        const success = await sendTelegramMessage(message);
        
        if (success) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
            z-index: 1000;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
          `;
          notification.textContent = 'üì¨ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram!';
          document.body.appendChild(notification);

          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => {
              document.body.removeChild(notification);
            }, 300);
          }, 3000);
        } else {
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
        }
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      telegramNotifyBtn.addEventListener('click', sendPaymentNotifications);

      function formatCurrency(value) {
        const number = Number(value) || 0;
        return number.toLocaleString('ru-RU', {
          style: 'currency',
          currency: 'RUB'
        });
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        if (Number.isNaN(date.getTime())) return '‚Äî';
        return date.toLocaleDateString('ru-RU', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }

      async function loadPayments() {
        try {
          const { data, error } = await supabase
            .from('payments')
            .select('*')
            .order('payment_date', { ascending: true });

          if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:', error);
            return;
          }

          payments = data.map(payment => ({
            id: payment.id.toString(),
            name: payment.name,
            amount: payment.amount,
            date: payment.payment_date,
            category: payment.category,
            categoryLabel: categoryLabel(payment.category)
          }));

          updateDashboard();
          renderTable('');
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', e);
        }
      }

      async function savePayment(paymentData) {
        try {
          console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:', paymentData);
          
          const { data, error } = await supabase
            .from('payments')
            .insert([{
              name: paymentData.name,
              amount: paymentData.amount,
              payment_date: paymentData.date,
              category: paymentData.category
            }])
            .select()
            .single();

          if (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            return null;
          }

          console.log('–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data);
          return data;
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', e);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + e.message);
          return null;
        }
      }

      async function updatePayment(id, paymentData) {
        try {
          const { data, error } = await supabase
            .from('payments')
            .update({
              name: paymentData.name,
              amount: paymentData.amount,
              payment_date: paymentData.date,
              category: paymentData.category
            })
            .eq('id', parseInt(id))
            .select()
            .single();

          if (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:', error);
            return null;
          }

          return data;
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', e);
          return null;
        }
      }

      async function deletePayment(id) {
        try {
          const { error } = await supabase
            .from('payments')
            .delete()
            .eq('id', parseInt(id));

          if (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:', error);
            return false;
          }

          return true;
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', e);
          return false;
        }
      }

      function updateDashboard() {
        const now = new Date();

        const total = payments.reduce((sum, p) => sum + Number(p.amount || 0), 0);
        totalMonthlyEl.textContent = formatCurrency(total);

        const futurePayments = payments
          .map((p) => ({ ...p, dateObj: new Date(p.date) }))
          .filter((p) => !Number.isNaN(p.dateObj.getTime()) && p.dateObj >= now)
          .sort((a, b) => a.dateObj - b.dateObj);

        if (futurePayments.length === 0) {
          nextPaymentEl.textContent = '‚Äî';
          nextPaymentMetaEl.textContent = '–ë–ª–∏–∂–∞–π—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç';
        } else {
          const next = futurePayments[0];
          nextPaymentEl.textContent = `${formatCurrency(next.amount)}`;
          nextPaymentMetaEl.textContent = `${next.name} ‚Äî ${formatDate(next.date)}`;
        }

        const counts = {
          subscription: 0,
          utilities: 0,
          credit: 0,
          other: 0
        };

        payments.forEach((p) => {
          if (counts[p.category] !== undefined) {
            counts[p.category] += 1;
          }
        });

        countSubscriptionEl.textContent = counts.subscription;
        countUtilitiesEl.textContent = counts.utilities;
        countCreditEl.textContent = counts.credit;
        countOtherEl.textContent = counts.other;
      }

      function renderTable(filterValue) {
        paymentsBody.innerHTML = '';

        const normalizedFilter = (filterValue || '').trim().toLowerCase();
        const filtered = normalizedFilter
          ? payments.filter((p) => {
              const text = (p.name + ' ' + p.categoryLabel).toLowerCase();
              return text.includes(normalizedFilter);
            })
          : payments;

        if (filtered.length === 0) {
          tableEmptyState.style.display = 'flex';
          return;
        }

        tableEmptyState.style.display = 'none';

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        filtered
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .forEach((payment) => {
            const tr = document.createElement('tr');

            const dueDate = new Date(payment.date);
            dueDate.setHours(0, 0, 0, 0);
            const msDiff = dueDate.getTime() - today.getTime();
            const daysDiff = msDiff / (1000 * 60 * 60 * 24);

            if (daysDiff >= 0 && daysDiff <= 3) {
              tr.classList.add('row-warning');
            }

            const nameTd = document.createElement('td');
            const nameText = document.createElement('span');
            nameText.textContent = payment.name;
            nameTd.appendChild(nameText);

            const amountTd = document.createElement('td');
            amountTd.textContent = formatCurrency(payment.amount);

            const dateTd = document.createElement('td');
            dateTd.textContent = formatDate(payment.date);

            const categoryTd = document.createElement('td');
            categoryTd.textContent = payment.categoryLabel;

            const actionsTd = document.createElement('td');
            actionsTd.className = 'table-actions-cell';

            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'icon-btn icon-btn-edit';
            editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂';
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.addEventListener('click', async () => {
              currentEditingId = payment.id;
              form.name.value = payment.name;
              form.amount.value = payment.amount;
              form.date.value = payment.date;
              form.category.value = payment.category;
              submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
              form.name.focus();
            });

            const paidBtn = document.createElement('button');
            paidBtn.type = 'button';
            paidBtn.className = 'icon-btn icon-btn-success';
            paidBtn.title = '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ –∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞—Ç—É';
            paidBtn.textContent = '‚úî';
            paidBtn.addEventListener('click', async () => {
              const currentDate = new Date(payment.date);
              if (Number.isNaN(currentDate.getTime())) return;

              const nextMonthDate = new Date(currentDate);
              nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);

              const year = nextMonthDate.getFullYear();
              const month = String(nextMonthDate.getMonth() + 1).padStart(2, '0');
              const day = String(nextMonthDate.getDate()).padStart(2, '0');

              const updatedPayment = await updatePayment(payment.id, {
                name: payment.name,
                amount: payment.amount,
                date: `${year}-${month}-${day}`,
                category: payment.category
              });

              if (updatedPayment) {
                await loadPayments();
              }
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'icon-btn icon-btn-danger';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç—ë–∂';
            deleteBtn.addEventListener('click', async () => {
              const success = await deletePayment(payment.id);
              if (success) {
                await loadPayments();
              }
            });

            actionsTd.appendChild(editBtn);
            actionsTd.appendChild(paidBtn);
            actionsTd.appendChild(deleteBtn);

            tr.appendChild(nameTd);
            tr.appendChild(amountTd);
            tr.appendChild(dateTd);
            tr.appendChild(categoryTd);
            tr.appendChild(actionsTd);

            paymentsBody.appendChild(tr);
          });
      }

      function categoryLabel(value) {
        switch (value) {
          case 'subscription':
            return '–ü–æ–¥–ø–∏—Å–∫–∞';
          case 'utilities':
            return '–ñ–ö–•';
          case 'credit':
            return '–ö—Ä–µ–¥–∏—Ç';
          default:
            return '–î—Ä—É–≥–æ–µ';
        }
      }

      function initTheme() {
        const stored = localStorage.getItem('paycontrol_theme');
        const prefersDark = window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches;

        const theme = stored || (prefersDark ? 'dark' : 'dark');
        document.documentElement.setAttribute('data-theme', theme);
        themeToggleBtn.textContent = theme === 'dark' ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      }

      themeToggleBtn.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        themeToggleBtn.textContent = next === 'dark' ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
        try {
          localStorage.setItem('paycontrol_theme', next);
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–º—É', e);
        }
      });

      function init() {
        currentYearEl.textContent = new Date().getFullYear();
        initTheme();
        loadPayments();
      }

      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>

